<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css"/>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
            integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
            crossorigin="anonymous"></script>
</head>
<body>
    <div id="header_div">
        <div class = "toolbar_button_group">
            <button class = "toolbar_button" id = "TB_GroupShapes">Group</button>
            <button class = "toolbar_button" id = "TB_UngroupShapes">Ungroup</button>
            <button class = "toolbar_button" id = "TB_BringToFront">Bring to Front</button>
            <button class = "toolbar_button" id = "TB_SendToBack">Send to Back</button>
            <button class = "toolbar_button" id = "TB_BringForward">Bring Forward</button>
            <button class = "toolbar_button" id = "TB_SendBackward">Send Backward</button>
        </div>
        <div class = "toolbar_button_group">
            <select name="selectmenu_zoom" id="zoom_option" width = "100">
                <option>10%</option>
                <option>25%</option>
                <option>50%</option>
                <option>75%</option>
                <option selected="selected">100%</option>
                <option>200%</option>
                <option>400%</option>
                <option>800%</option>
                <option>Fit to Screen</option>
            </select>
            <button class = "toolbar_button" id = "TB_ZoomIn">Zoom In</button>
            <button class = "toolbar_button" id = "TB_ZoomOut">Zoom Out</button>
        </div>
        <div class = "toolbar_button_group">
            <button class = "toolbar_button" id = "TB_Undo">Undo</button>
            <button class = "toolbar_button" id = "TB_Redo">Redo</button>
            <button class = "toolbar_button" id = "TB_Cut">Cut</button>
            <button class = "toolbar_button" id = "TB_Copy">Copy</button>
            <button class = "toolbar_button" id = "TB_Paste">Paste</button>
        </div>
        <div class = "toolbar_button_group">
            <button class = "toolbar_button" id = "TB_Pointer">Pointer</button>
            <button class = "toolbar_button" id = "TB_HandTool">Hand Tool</button>
            <button class = "toolbar_button" id = "TB_LineTool">Line Tool</button>
            <button class = "toolbar_button" id = "TB_LineWidth">Line Width</button>
        </div>
        <div class = "toolbar_button_group">
            <button class = "toolbar_button" id = "TB_Share">Share</button>
        </div>
    </div>
    <div id="center_div">
        <div id="toolpanel_div">
            <div id = "toolbar_accordian">
                <h3>Basic Shapes</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_Triangle" title = "Triangle">Triangle</div>
                    <div class = "shape_icon" id = "holder_Rectangle" title = "Rect">Rect</div>
                    <div class = "shape_icon" id = "holder_Square" title = "Square">Square</div>
                    <div class = "shape_icon" id = "holder_Polygon" title = "Polygon">Polygon</div>
                    <div class = "shape_icon" id = "holder_Star" title = "Star">Star</div>
                    <div class = "shape_icon" id = "holder_Cog" title = "Cog">Cog</div>
                    <div class = "shape_icon" id = "holder_RoundedRectangle" title = "Rounded Rectangle">Rounded Rectangle</div>
                    <div class = "shape_icon" id = "holder_Plus" title = "Plus">Plus</div>
                    <div class = "shape_icon" id = "holder_Circle" title = "Circle">Circle</div>
                    <div class = "shape_icon" id = "holder_Ellipse" title = "Ellipse">Ellipse</div>

                    <div class = "shape_icon" id = "holder_LeftArrow" title = "Left Arrow">Left Arrow</div>
                    <div class = "shape_icon" id = "holder_RightArrow" title = "Right Arrow">Right Arrow</div>
                    <div class = "shape_icon" id = "holder_DoubleArrow" title = "Double Arrow">Double Arrow</div>

                    <div class = "shape_icon" id = "holder_Cylinder" title = "Cylinder">Cylinder</div>
                    <div class = "shape_icon" id = "holder_LeftBlockArrow" title = "Left Block Arrow">Left Block Arrow</div>
                    <div class = "shape_icon" id = "holder_RightBlockArrow" title = "Right Block Arrow">Right Block Arrow</div>

                    <div class = "shape_icon" id = "holder_LeftChevron" title = "Left Chevron">Left Chevron</div>
                    <div class = "shape_icon" id = "holder_RightChevron" title = "Right Chevron">Right Chevron</div>
                </div>
                <h3>Connectors</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_StraightConnector" title = "Straight Connector">Straight Connector</div>
                    <div class = "shape_icon" id = "holder_ElbowConnector" title = "Elbow Connector">Elbow Connector</div>
                    <div class = "shape_icon" id = "holder_CurvedConnector" title = "Curved Connector">Curved Connector</div>
                </div>
                <h3>Devices</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_InMemCache" title = "InMem Cache">InMem Cache</div>
                    <div class = "shape_icon" id = "holder_DistributedCache" title = "Dist Cache">Dist Cache</div>
                    <div class = "shape_icon" id = "holder_LoadBalancer" title = "Load Balancer">Load Balancer</div>
                    <div class = "shape_icon" id = "holder_WebServer" title = "Web Server">Web Server</div>
                    <div class = "shape_icon" id = "holder_Database" title = "Database">Database</div>
                    <div class = "shape_icon" id = "holder_BTreeIndex" title = "BTree Index">BTree Index</div>
                    <div class = "shape_icon" id = "holder_HashIndex" title = "Hash Index">Hash Index</div>
                    <div class = "shape_icon" id = "holder_KafkaQueue" title = "Kafka Queue">Kafka Queue</div>
                </div>
                <h3>Links</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_NetworkLink" title = "Network Link">Network Link</div>
                </div>
            </div>
        </div>
        <div id="splitbar" class = "draggable ui-widget-content"></div>
        <div id = "stage_div"></div>
    </div>
    <div id="footer_div"></div>
</body>
<script>
    iconStages = { };
    theScene = null;
    theStage = null;

    x = null;
    ctx = null;
    function drawSample(x, y, w, h, angle, clear) { if (clear)
            ctx.clearRect(0, 0, 2000, 2000);
        ctx.save();
        ctx.lineWidth = 2.0;
        cx = x + w / 2;
        cy = y + h / 2;
        ctx.translate(cx, cy);
        var theta = Math.PI * angle / 180;
        ctx.rotate(theta);
        ctx.translate(-cx, -cy);
        costheta = Math.cos(theta) / 2;
        sintheta = Math.sin(theta);
        ctx.strokeRect(x, y, w, h);

        // Draw Center
        ctx.beginPath();
        ctx.arc(cx, cy, 3, 0, 2 * Math.PI);
        ctx.fillStyle = "green";
        ctx.fill();
        ctx.restore();
    }

    function test() {
        ctx = theStage.getPane("main").context;
        x = theScene._layers[0]._children[0];
        x.rotate(30);
        // scaling when drawing is using the "wrong" offset.  For some reason x and y are fine but still looks "jilted"

        drawSample(100, 50);
    }

    $(document).ready(function() {
        setupElements();
        loadComponents();
        setupHeaderToolbar();
    });

    function setupElements() {
        setupSplitBar();
        setupAccordian();
        layoutElements();
        $( window ).resize(function() { layoutElements(); });
        setupCanvas();
    }

    function setupSplitBar() {
        $("#splitbar").draggable({
            axis: "x",
            drag: layoutElements
        });
    }

    function setupAccordian() {
        $( "#toolbar_accordian" ).accordion({
            collapsible:true,
            beforeActivate: function(event, ui) {
                 // The accordion believes a panel is being opened
                if (ui.newHeader[0]) {
                    var currHeader  = ui.newHeader;
                    var currContent = currHeader.next('.ui-accordion-content');
                 // The accordion believes a panel is being closed
                } else {
                    var currHeader  = ui.oldHeader;
                    var currContent = currHeader.next('.ui-accordion-content');
                }
                 // Since we've changed the default behavior, this detects the actual status
                var isPanelSelected = currHeader.attr('aria-selected') == 'true';

                 // Toggle the panel's header
                currHeader.toggleClass('ui-corner-all',isPanelSelected).toggleClass('accordion-header-active ui-state-active ui-corner-top',!isPanelSelected).attr('aria-selected',((!isPanelSelected).toString()));

                // Toggle the panel's icon
                currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e',isPanelSelected).toggleClass('ui-icon-triangle-1-s',!isPanelSelected);

                 // Toggle the panel's content
                currContent.toggleClass('accordion-content-active',!isPanelSelected)    
                if (isPanelSelected) { currContent.slideUp(); }  else { currContent.slideDown(); }

                return false; // Cancels the default action
            }
        });
    }

    function setupCanvas() {
        theScene = new Sistine.core.Scene();
        theStage = new Sistine.stage.Stage("stage_div", theScene);
        var DefaultBundle = Sistine.registry.DefaultBundle;
        var triangle = new DefaultBundle.Triangle.newShape({
            "x": 20, "y": 50, "width": 200, "height": 200, "lineWidth": 2
        });
        var rect = new DefaultBundle.Rectangle.newShape({
            "x": 200, "y": 100, "width": 100, "height": 50, "lineWidth": 2
        });
        var square = new DefaultBundle.Square.newShape({
            "x": 550, "y": 100, "width": 200, "height": 100, "fillStyle": 'red'
        });
        theScene.add(rect);
        theScene.add(triangle);
        theScene.add(square);

        theStage.repaint();
        theStage.isEditable = true;
        theStage.showBackground = true;
        theStage.setZoom(2);
    }

    /**
     * Sets up the canvas initially and ensures it dynamically adjusts to the size of the screen.
     */
    function layoutElements(e, ui) {
        var stage_div = $("#stage_div");
        var splitbar = $("#splitbar");
        var toolpanel_div = $("#toolpanel_div");

        // setup toolpanel width
        toolpanel_div.width(splitbar.position().left);

        // setup stage_div width
        stage_div.css("left", splitbar.position().left + splitbar.width());
        if (theStage) { theStage.layout(); }
    }

    function loadComponents() {
        var shape_icons = $(".shape_icon");
        shape_icons.each(function(index, icondiv) {
            // We have divs where these buttons should go.
            // What we need is some kind of element in these buttons, that will:
            // 1. Show the icon corresponding to that button
            // 2. Add a drag handler that will let us drop that *component* onto the canvas
            // 3. Associate the button to an actual node component.
            // 4. This implies the node component corresponding to the ID will be responsible for the above.
            var $icondiv = $(icondiv)
            $icondiv.empty()

            var shapeId = icondiv.id.replace(/holder_/, "");
            var iconStage = iconStages[shapeId] = new Sistine.stage.Stage(icondiv.id);
            var topPane = iconStage.getPane("main");
            var $child = topPane.element;

            var DefaultBundle = Sistine.registry.DefaultBundle;
            var margin = 3;
            var toolbarShape = DefaultBundle[shapeId].newShapeForToolbar({
                lineWidth: 2,
                x: margin,
                y: margin,
                width: $child.width() - (
                    Sistine.utils.dom.getcssint($child, "margin-left") +
                    Sistine.utils.dom.getcssint($child, "margin-right")
                ) - (margin * 2),
                height: $child.height() - (
                    Sistine.utils.dom.getcssint($child, "margin-top") +
                    Sistine.utils.dom.getcssint($child, "margin-bottom")
                ) - (margin * 2)
            });
            iconStage.scene.add(toolbarShape);
            iconStage.layout();
            iconStage.repaint();
            // topPane.element.tooltip();

            // Setup highlighter!
            topPane.element.mouseover(function(event) {
                $(event.currentTarget).addClass("toolbar_button_highlighted");
            }).mouseout(function(event) {
                $(event.currentTarget).removeClass("toolbar_button_highlighted");
            }).click(function(event) {
                // Add the shape on the canvas at the center
                var id = event.currentTarget.id.replace(/mainpane_holder_/, "");
                addShapeFromToolbar(id);
            });
        });
    }

    function addShapeFromToolbar(objid) {
        var DefaultBundle = Sistine.registry.DefaultBundle;
        console.log("Toolbar Clicked: " + objid);
        theStage.touchHandler.shapeForCreation = DefaultBundle[objid].newShape();
    }
</script>
</html>
