<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css"/>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
            integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
            crossorigin="anonymous"></script>
</head>
<body>
    <div id="header_div"></div>
    <div id="center_div">
        <div id="toolpanel_div">
            <div id = "toolbar_accordian">
                <h3>Basic Shapes</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_triangle">Triangle</div>
                    <div class = "shape_icon" id = "holder_rect">Rect</div>
                    <div class = "shape_icon" id = "holder_square">Square</div>
                    <div class = "shape_icon" id = "holder_regpolygon">Polygon</div>
                    <div class = "shape_icon" id = "holder_star">Star</div>
                    <div class = "shape_icon" id = "holder_cog">Cog</div>
                    <div class = "shape_icon" id = "holder_rounded_rect">Rounded Rectangle</div>
                    <div class = "shape_icon" id = "holder_plus">Plus</div>
                    <div class = "shape_icon" id = "holder_circle">Circle</div>
                    <div class = "shape_icon" id = "holder_ellipse">Ellipse</div>

                    <div class = "shape_icon" id = "holder_left_arrow">Left Arrow</div>
                    <div class = "shape_icon" id = "holder_right_arrow">Right Arrow</div>
                    <div class = "shape_icon" id = "holder_double_arrow">Double Arrow</div>

                    <div class = "shape_icon" id = "holder_cylinder">Cylinder</div>
                    <div class = "shape_icon" id = "holder_left_block_arrow">Left Block Arrow</div>
                    <div class = "shape_icon" id = "holder_right_block_arrow">Right Block Arrow</div>

                    <div class = "shape_icon" id = "holder_left_chevron">Left Chevron</div>
                    <div class = "shape_icon" id = "holder_right_chevron">Right Chevron</div>
                </div>
                <h3>Connectors</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_straight_connector">Straight Connector</div>
                    <div class = "shape_icon" id = "holder_elbow_connector">Elbow Connector</div>
                    <div class = "shape_icon" id = "holder_curved_connector">Curved Connector</div>
                </div>
                <h3>Devices</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_inmem_cache">InMem Cache</div>
                    <div class = "shape_icon" id = "holder_dist_cache">Dist Cache</div>
                    <div class = "shape_icon" id = "holder_load_balancer">Load Balancer</div>
                    <div class = "shape_icon" id = "holder_web_server">Web Server</div>
                    <div class = "shape_icon" id = "holder_database">Database</div>
                    <div class = "shape_icon" id = "holder_btree_index">BTree Index</div>
                    <div class = "shape_icon" id = "holder_hash_index">Hash Index</div>
                    <div class = "shape_icon" id = "holder_kafka_queue">Kafka Queue</div>
                </div>
                <h3>Links</h3>
                <div class = "toolbar_section_div">
                    <div class = "shape_icon" id = "holder_network_link">Network Link</div>
                </div>
            </div>
        </div>
        <div id="splitbar" class = "draggable ui-widget-content"></div>
        <div id = "stage_div"></div>
    </div>
    <div id="footer_div"></div>
</body>
<script>
    iconStages = { };
    theScene = null;
    theStage = null;

    $(document).ready(function() {
        setupElements();
        loadComponents();
    });

    function setupElements() {
        setupSplitBar();
        setupAccordian();
        layoutElements();
        $( window ).resize(function() { layoutElements(); });
        setupCanvas();
    }

    function setupSplitBar() {
        $("#splitbar").draggable({
            axis: "x",
            drag: layoutElements
        });
    }

    function setupAccordian() {
        $( "#toolbar_accordian" ).accordion({
            collapsible:true,
            beforeActivate: function(event, ui) {
                 // The accordion believes a panel is being opened
                if (ui.newHeader[0]) {
                    var currHeader  = ui.newHeader;
                    var currContent = currHeader.next('.ui-accordion-content');
                 // The accordion believes a panel is being closed
                } else {
                    var currHeader  = ui.oldHeader;
                    var currContent = currHeader.next('.ui-accordion-content');
                }
                 // Since we've changed the default behavior, this detects the actual status
                var isPanelSelected = currHeader.attr('aria-selected') == 'true';

                 // Toggle the panel's header
                currHeader.toggleClass('ui-corner-all',isPanelSelected).toggleClass('accordion-header-active ui-state-active ui-corner-top',!isPanelSelected).attr('aria-selected',((!isPanelSelected).toString()));

                // Toggle the panel's icon
                currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e',isPanelSelected).toggleClass('ui-icon-triangle-1-s',!isPanelSelected);

                 // Toggle the panel's content
                currContent.toggleClass('accordion-content-active',!isPanelSelected)    
                if (isPanelSelected) { currContent.slideUp(); }  else { currContent.slideDown(); }

                return false; // Cancels the default action
            }
        });
    }

    function setupCanvas() {
        theScene = new Sistine.core.Scene();
        theStage = new Sistine.stage.Stage("stage_div", theScene);
        var DefaultBundle = Sistine.registry.DefaultBundle;
        var triangle = new DefaultBundle.triangle.Triangle({
            "x": 20, "y": 50, "width": 200, "height": 200, "lineWidth": 2
        });
        var rect = new DefaultBundle.rect.Rectangle({
            "x": 250, "y": 100, "width": 200, "height": 200, "fillStyle": 'red'
        });
        var square = new DefaultBundle.square.Square({
            "x": 550, "y": 100, "width": 200, "height": 100, "fillStyle": 'red'
        });
        theScene.add(rect);
        theScene.add(triangle);
        theScene.add(square);

        theStage.repaint();
        theStage.isEditable = true;
        /*
        theStage.mouseover(function(event) {
            // console.log("1. Mouse Over: " + event);
            // event.stopImmediatePropagation();
        }).mouseout(function(event) {
            // console.log("1. Mouse Out: " + event);
        }).mousedown(function(event) {
            //console.log("1. Mouse down: " + event);
        }).mouseup(function(event) {
            // console.log("1. Mouse up: " + event);
        }).mouseenter(function(event) {
            // console.log("1. Mouse enter: " + event);
        }).mouseleave(function(event) {
            // console.log("1. Mouse leave: " + event);
        }).mousemove(function(event) {
            // theStage.repaint();
        });
        */
    }

    /**
     * Sets up the canvas initially and ensures it dynamically adjusts to the size of the screen.
     */
    function layoutElements(e, ui) {
        var stage_div = $("#stage_div");
        var splitbar = $("#splitbar");
        var toolpanel_div = $("#toolpanel_div");

        // setup toolpanel width
        toolpanel_div.width(splitbar.position().left);

        // setup stage_div width
        stage_div.css("left", splitbar.position().left + splitbar.width());
        if (theStage) { theStage.layout(); }
    }

    function loadComponents() {
        var shape_icons = $(".shape_icon");
        shape_icons.each(function(index, icondiv) {
            // We have divs where these buttons should go.
            // What we need is some kind of element in these buttons, that will:
            // 1. Show the icon corresponding to that button
            // 2. Add a drag handler that will let us drop that *component* onto the canvas
            // 3. Associate the button to an actual node component.
            // 4. This implies the node component corresponding to the ID will be responsible for the above.
            var $icondiv = $(icondiv)
            var tooltip = $icondiv.text();
            $icondiv.empty()
            $icondiv.attr("title", tooltip);

            var shapeId = icondiv.id.replace(/holder_/, "");
            var iconStage = iconStages[shapeId] = new Sistine.stage.Stage(icondiv.id);
            var $child = iconStage.topCanvas.element;

            var DefaultBundle = Sistine.registry.DefaultBundle;
            var margin = 3;
            var toolbarShape = DefaultBundle[shapeId].createForToolbar({
                lineWidth: 2,
                x: margin,
                y: margin,
                width: $child.width() - (
                    Sistine.utils.dom.getcssint($child, "margin-left") +
                    Sistine.utils.dom.getcssint($child, "margin-right")
                ) - (margin * 2),
                height: $child.height() - (
                    Sistine.utils.dom.getcssint($child, "margin-top") +
                    Sistine.utils.dom.getcssint($child, "margin-bottom")
                ) - (margin * 2)
            });
            iconStage.scene.add(toolbarShape);
            iconStage.layout();
            iconStage.repaint();
            // iconStage.topCanvas.element.tooltip();

            // Setup highlighter!
            iconStage.topCanvas.element.mouseover(function(event) {
                $(event.currentTarget).addClass("toolbar_button_highlighted");
            }).mouseout(function(event) {
                $(event.currentTarget).removeClass("toolbar_button_highlighted");
            }).click(function(event) {
                // Add the shape on the canvas at the center
                var id = event.currentTarget.id.replace(/canvas_/, "");
                addShapeForToolbar(id);
            });
        });
    }

    function addShapeForToolbar(objid) {
        console.log("Clicked: " + objid);
        // what is needed here:
        // 1. see which shape was clicked
        // 2. Find canvas bounds and viewport
        // 3. Find viewport center
        // 4. create a default shape instance
        // 5. add shape at viewport center
    }
</script>
</html>
